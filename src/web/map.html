<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Museum Smart Router</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    /* Basic Reset & Layout */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f4f4f9; color: #333; }
    header { background: #2c3e50; color: #fff; padding: 1rem; text-align: center; }
    
    main { display: grid; grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; max-width: 1400px; margin: 0 auto; }
    
    /* Panels */
    .panel { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h3 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; color: #2c3e50; }
    
    /* Form Elements */
    label { display:block; margin-top: 12px; font-weight: 600; font-size: 14px; }
    input[type="number"], input[type="text"], input[type="checkbox"] { margin-top: 4px; padding: 6px; width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
    input[type="checkbox"] { width: auto; }
    
    button#goBtn {
      background: #27ae60; color: white; border: none; padding: 12px; width: 100%;
      font-size: 16px; margin-top: 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s;
    }
    button#goBtn:hover { background: #219150; }

    /* Results Area */
    #mapContainer { text-align: center; background: #fafafa; border: 1px dashed #ccc; min-height: 400px; display: flex; align-items: center; justify-content: center; overflow: auto; }
    #mapImage { max-width: 100%; display: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .placeholder-text { color: #999; font-style: italic; }

    /* Route Steps List */
    #routeSteps { margin-top: 20px; }
    .step-card { border: 1px solid #eee; border-left: 4px solid #3498db; padding: 10px; margin-bottom: 10px; background: #fff; }
    .step-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .step-title { font-weight: bold; font-size: 1.1em; }
    .step-meta { font-size: 0.9em; color: #666; }
    
    /* Exhibits & Feedback */
    .exhibit-list { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; display: none; }
    .exhibit-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f9f9f9; }
    .feedback-controls { display: flex; gap: 5px; align-items: center; }
    .btn-rate { background: #e67e22; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn-rate:hover { background: #d35400; }
    
    .loading { color: #7f8c8d; font-style: italic; display: none; }
  </style>
</head>
<body>

<header>
  <h2>üèõÔ∏è Museum Smart Tour System</h2>
</header>

<main>
  <section class="panel">
    <h3>üìã Plan Your Visit</h3>
    <label>Time Budget (min)
      <input id="timeBudget" type="number" value="35" min="5" step="1">
    </label>
    

    <label>Walking Speed (m/min)
      <input id="speed" type="number" value="60">
    </label>
    
    <label>
      <input id="returnEntrance" type="checkbox" checked> Return to entrance at the end?
    </label>
    
    <label>Preferences (JSON)
      <input id="prefs" type="text" value='{"painting": 1.5, "sculpture": 0.8}'>
    </label>
    
    <label>Must Visit (Room IDs)
      <input id="must" type="text" placeholder="e.g. room_1, room_3">
    </label>
    
    <label>Avoid (Room IDs)
      <input id="avoid" type="text" placeholder="e.g. room_5">
    </label>

   <label>Maximum Rooms to Visit
      <input id="max_stops" type="number" placeholder="e.g. 5">
    </label>


    <button id="goBtn">üöÄ Generate Optimal Route</button>
  </section>

  <section class="panel">
    <h3>üó∫Ô∏è Route Visualization</h3>
    <div id="mapContainer">
      <span class="placeholder-text">Please configure preferences and click "Generate" to see the map.</span>
      <span class="loading">Calculating best path...</span>
      <img id="mapImage" alt="Route Map" />
    </div>

    <h3>üìç Itinerary & Feedback</h3>
    <div id="routeSteps">
      <p style="color:#777;">Plan a route to see the step-by-step itinerary.</p>
    </div>
  </section>
</main>

<script>
const API_BASE = ""; // Relative path

document.getElementById("goBtn").addEventListener("click", generateRoute);

async function generateRoute() {
  const btn = document.getElementById("goBtn");
  const mapImg = document.getElementById("mapImage");
  const loading = document.querySelector("#mapContainer .loading");
  const placeholder = document.querySelector("#mapContainer .placeholder-text");
  const stepsContainer = document.getElementById("routeSteps");

  // UI State: Loading
  btn.disabled = true;
  btn.innerText = "Computing...";
  if(placeholder) placeholder.style.display = "none";
  mapImg.style.display = "none";
  loading.style.display = "block";
  stepsContainer.innerHTML = '<p class="loading" style="display:block">Calculating best path...</p>';

  try {
    // 1. Prepare Payload
    const payload = getPayloadFromUI();

    // 2. Fetch DATA + IMAGE in a single request (Optimization)
    const res = await fetch(`${API_BASE}/route/plan-rooms`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    
    if (!res.ok) throw new Error("Failed to calculate route");
    const routeData = await res.json();

    // 3. Update UI
    
    // Display the image from Base64 string
    if (routeData.map_base64) {
        mapImg.src = `data:image/png;base64,${routeData.map_base64}`;
        mapImg.style.display = "block";
    }

    loading.style.display = "none";
    
    renderRouteSteps(routeData);

  } catch (err) {
    alert("Error: " + err.message);
    loading.style.display = "none";
    if(placeholder) placeholder.style.display = "block";
    placeholder.innerText = "Error loading data.";
  } finally {
    btn.disabled = false;
    btn.innerText = "üöÄ Generate Optimal Route";
  }
}

function getPayloadFromUI() {
  const parseList = (id) => document.getElementById(id).value.split(",").map(s=>s.trim()).filter(Boolean);
  
  let prefs = {};
  try { prefs = JSON.parse(document.getElementById("prefs").value); } catch(e) {}

  return {
    time_budget_min: parseFloat(document.getElementById("timeBudget").value),
    entrance: [0, 0, 0],
    speed_m_per_min: parseFloat(document.getElementById("speed").value),
    return_to_entrance: document.getElementById("returnEntrance").checked,
    prefs: prefs,
    must_visit: parseList("must"),
    avoid: parseList("avoid"),
    max_stops: parseInt(document.getElementById("max_stops").value)
  };
}

function renderRouteSteps(data) {
  const container = document.getElementById("routeSteps");
  container.innerHTML = `
    <div style="margin-bottom:15px; font-weight:bold; color:#27ae60;">
      Total Time: ${data.total_time_min} min | 
      Walk: ${data.total_walk_min} min | 
      View: ${data.total_view_min} min
    </div>
  `;

  if (!data.path || data.path.length === 0) {
    container.innerHTML += "<p>No rooms visited.</p>";
    return;
  }

  data.path.forEach((step, index) => {
    const div = document.createElement("div");
    div.className = "step-card";
    div.innerHTML = `
      <div class="step-header" onclick="toggleExhibits('${step.id}', this)">
        <div>
          <span class="step-title">${index + 1}. ${step.name}</span>
          <div class="step-meta">Time here: ${step.view_min} min | Score: ${step.score_weighted}</div>
        </div>
        <button style="font-size:12px;">‚ñº Rate Exhibits</button>
      </div>
      <div class="exhibit-list" id="exhibits-${step.id}">
        <div class="loading" style="display:block">Loading exhibits...</div>
      </div>
    `;
    container.appendChild(div);
  });
}

async function toggleExhibits(roomId, headerEl) {
  const listEl = document.getElementById(`exhibits-${roomId}`);
  
  // Toggle visibility
  if (listEl.style.display === "block") {
    listEl.style.display = "none";
    return;
  }
  listEl.style.display = "block";

  // Load data if not already loaded
  if (listEl.dataset.loaded === "true") return;

  try {
    const res = await fetch(`${API_BASE}/rooms/${roomId}/exhibits`);
    const exhibits = await res.json();
    
    if (exhibits.length === 0) {
      listEl.innerHTML = "<small>No exhibits in this room.</small>";
    } else {
      listEl.innerHTML = exhibits.map(ex => `
      <div class="exhibit-item">
        <div style="flex-grow:1">
          <strong>${ex.name}</strong> <span style="font-size:0.8em;color:#888">(${ex.type})</span><br>
          <small>Current Score: ${ex.score.toFixed(2)} | Avg Time: ${ex.avg_view_time_min ? ex.avg_view_time_min.toFixed(1) : '-'} min</small>
        </div>
        <div class="feedback-controls" style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
          <div style="display:flex; gap:4px;">
             <input type="number" id="time-${ex.id}" placeholder="Sec" value="120" style="width:50px; padding:4px; font-size:12px;">
             <select id="rate-${ex.id}" style="padding:4px;">
              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="3" selected>‚≠ê‚≠ê‚≠ê</option>
              <option value="2">‚≠ê‚≠ê</option>
              <option value="1">‚≠ê</option>
            </select>
          </div>
          <button class="btn-rate" style="width:100%" onclick="submitFeedback('${ex.id}')">Submit Feedback</button>
        </div>
      </div>
    `).join("");
    }
    listEl.dataset.loaded = "true";
  } catch (e) {
    listEl.innerHTML = "<small style='color:red'>Error loading exhibits.</small>";
  }
}

async function submitFeedback(exhibitId) {
  const ratingVal = document.getElementById(`rate-${exhibitId}`).value;
  
  // Get time from input, fallback to 60 seconds if empty or invalid
  let viewTimeInput = document.getElementById(`time-${exhibitId}`).value;
  let viewTime = parseInt(viewTimeInput);
  
  if (isNaN(viewTime) || viewTime <= 0) {
      viewTime = 60; // Default fallback
  }

  try {
    const res = await fetch(`${API_BASE}/feedback`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        exhibit_id: exhibitId,
        rating: parseInt(ratingVal),
        view_seconds: viewTime
      })
    });
    
    if (res.ok) {
      const data = await res.json();
      // Show explicit confirmation of the update
      alert(`Feedback Received!\n\nNew Score: ${data.new_score.toFixed(2)}\nNew Avg Time: ${data.new_avg_view_time_min.toFixed(2)} min`);
      
      // Optional: Update the UI text immediately without refreshing
      // (This requires finding the specific span, but alert is enough for demo)
    } else {
      alert("Error sending feedback");
    }
  } catch(e) {
    alert("Network error: " + e.message);
  }
}
</script>
</body>
</html>